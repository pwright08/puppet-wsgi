#!/usr/bin/env bash
# Startup script for Land Registry's <%= @name %> WSGI application

# Port the application should listen on
PORT=<%= @bind %>

# Load environment variables
echo 'Loading environment variables...'
source <%= @cfg_file  %>

# Ensure python can find modules correctly
PYTHONPATH='<%= @code_dir %>'
cd <%= @code_dir %>

<%- if @manage == true -%>
# Run database migration if manage.py script exists
if [ -f '<%= @code_dir %>/manage.py' ]; then
  echo 'Running migration script...'
  PYTHON='<%= @venv_dir %>/bin/python'
  $PYTHON <%= @code_dir %>/manage.py db upgrade
  # If the migration doesn't happen successfully, die
  if [ $? != '0' ]; then
    echo 'Migration script failed to run successfully'
    exit 1
  fi
fi
<%- end -%>

<%- if @app_type == 'wsgi' -%>
# Run time
echo "Starting web service on ${PORT}..."
GUNICORN='<%= @venv_dir %>/bin/gunicorn'
$GUNICORN --bind           0.0.0.0:${PORT} \
          --name           <%= @service  %> \
          --pid            '<%= @pid_file %>' \
          --chdir          '<%= @code_dir %>/' \
          --access-logfile '<%= @access_log %>' \
          --error-logfile  '<%= @error_log %>' \
          --log-level      <%= @log_level %> \
          <%= @wsgi_entry %> # Entry point

<%- elsif @app_type == 'python' -%>
<%= @venv_dir %>/bin/python <%= @code_dir %>/run.py

<% end %>
